{"version":3,"file":"index.umd.js","sources":["../src/utils.ts","../src/createTrackedSelector.ts","../src/createContainer.ts","../src/memo.ts"],"sourcesContent":["import { useEffect, useRef, useDebugValue } from 'react';\nimport { affectedToPathList } from 'proxy-compare';\n\ntype Obj = Record<string, unknown>;\n\nexport const useAffectedDebugValue = <State>(\n  state: State,\n  affected: WeakMap<Obj, unknown>,\n) => {\n  const pathList = useRef<(string | number | symbol)[][]>();\n  useEffect(() => {\n    pathList.current = affectedToPathList(state, affected);\n  });\n  useDebugValue(state);\n};\n","import {\n  useCallback,\n  useEffect,\n  useMemo,\n  useReducer,\n  useRef,\n} from 'react';\nimport { createProxy, isChanged } from 'proxy-compare';\n\nimport { useAffectedDebugValue } from './utils';\n\nexport const createTrackedSelector = <State>(\n  useSelector: <Selected>(selector: (state: State) => Selected) => Selected,\n) => {\n  const useTrackedSelector = () => {\n    const [, forceUpdate] = useReducer((c) => c + 1, 0);\n    const affected = new WeakMap();\n    const lastAffected = useRef<typeof affected>();\n    const prevState = useRef<State>();\n    const lastState = useRef<State>();\n    useEffect(() => {\n      lastAffected.current = affected;\n      if (prevState.current !== lastState.current\n        && isChanged(\n          prevState.current,\n          lastState.current,\n          affected,\n          new WeakMap(),\n        )) {\n        prevState.current = lastState.current;\n        forceUpdate();\n      }\n    });\n    const selector = useCallback((nextState: State) => {\n      lastState.current = nextState;\n      if (prevState.current\n        && prevState.current !== nextState\n        && lastAffected.current\n        && !isChanged(\n          prevState.current,\n          nextState,\n          lastAffected.current,\n          new WeakMap(),\n        )\n      ) {\n        // not changed\n        return prevState.current;\n      }\n      prevState.current = nextState;\n      return nextState;\n    }, []);\n    const state = useSelector(selector);\n    if (typeof process === 'object' && process.env.NODE_ENV !== 'production') {\n      // eslint-disable-next-line react-hooks/rules-of-hooks\n      useAffectedDebugValue(state, affected);\n    }\n    const proxyCache = useMemo(() => new WeakMap(), []); // per-hook proxyCache\n    return createProxy(state, affected, proxyCache);\n  };\n  return useTrackedSelector;\n};\n","/* eslint react/destructuring-assignment: off */\n\nimport {\n  ComponentType,\n  Context as ContextOrig,\n  ReactNode,\n  createContext as createContextOrig,\n  createElement,\n  useCallback,\n  useContext as useContextOrig,\n  useDebugValue,\n} from 'react';\n\nimport {\n  Context,\n  createContext,\n  useContextSelector,\n  useContextUpdate,\n} from 'use-context-selector';\n\nimport { createTrackedSelector } from './createTrackedSelector';\n\ntype AnyFunction = (...args: any[]) => any;\ntype Options<State, Update extends AnyFunction> = {\n  defaultState?: State;\n  defaultUpdate?: Update;\n  stateContextName?: string;\n  updateContextName?: string;\n  concurrentMode?: boolean;\n}\n/**\n * [Deprecated] Please use object option\n */\ntype DeprecatedOption = boolean\n\nexport const createContainer = <State, Update extends AnyFunction, Props>(\n  useValue: (props: Props) => readonly [State, Update],\n  options?: Options<State, Update> | DeprecatedOption,\n) => {\n  if (typeof options === 'boolean') {\n    // eslint-disable-next-line no-console\n    console.warn('boolean option is deprecated, please specify { concurrentMode: true }');\n    options = { concurrentMode: options };\n  }\n  const {\n    stateContextName = 'StateContainer',\n    updateContextName = 'UpdateContainer',\n    concurrentMode,\n  } = options || {};\n  const StateContext = createContext<State | undefined>(options?.defaultState);\n  const UpdateContext = createContextOrig<Update | undefined>(options?.defaultUpdate);\n  StateContext.displayName = stateContextName;\n  UpdateContext.displayName = updateContextName;\n\n  const Provider = (props: Props & { children: ReactNode }) => {\n    const [state, update] = useValue(props);\n    return createElement(\n      UpdateContext.Provider,\n      { value: update },\n      createElement(StateContext.Provider as ComponentType<{\n        value: State;\n      }>, { value: state }, props.children),\n    );\n  };\n\n  const useSelector = <Selected>(\n    selector: (state: State) => Selected,\n  ) => {\n    if (\n      typeof process === 'object'\n      && process.env.NODE_ENV !== 'production'\n    ) {\n      const selectorOrig = selector;\n      selector = (state: State) => {\n        if (state === undefined) {\n          throw new Error('Please use <Provider>');\n        }\n        return selectorOrig(state);\n      };\n    }\n    const selected = useContextSelector(StateContext as Context<State>, selector);\n    useDebugValue(selected);\n    return selected;\n  };\n\n  const useTrackedState = createTrackedSelector(useSelector);\n\n  const useUpdate = concurrentMode\n    ? () => {\n      if (\n        typeof process === 'object'\n        && process.env.NODE_ENV !== 'production'\n        && useContextOrig(UpdateContext) === undefined\n      ) {\n        throw new Error('Please use <Provider>');\n      }\n      const contextUpdate = useContextUpdate(StateContext as Context<unknown>);\n      const update = useContextOrig(UpdateContext as ContextOrig<Update>);\n      return useCallback((...args: Parameters<Update>) => {\n        let result: ReturnType<Update> | undefined;\n        contextUpdate(() => {\n          result = update(...args);\n        });\n        return result as ReturnType<Update>;\n      }, [contextUpdate, update]);\n    }\n    // not concurrentMode\n    : () => {\n      if (\n        typeof process === 'object'\n        && process.env.NODE_ENV !== 'production'\n        && useContextOrig(UpdateContext) === undefined\n      ) {\n        throw new Error('Please use <Provider>');\n      }\n      return useContextOrig(UpdateContext as ContextOrig<Update>);\n    };\n\n  const useTracked = () => [useTrackedState(), useUpdate()] as [\n    ReturnType<typeof useTrackedState>,\n    ReturnType<typeof useUpdate>,\n  ];\n\n  return {\n    Provider,\n    useTrackedState,\n    useTracked,\n    useUpdate,\n    useSelector,\n  } as const;\n};\n","import { createElement, memo as reactMemo, forwardRef } from 'react';\nimport { trackMemo } from 'proxy-compare';\n\nimport type {\n  PropsWithChildren,\n  NamedExoticComponent,\n  ComponentType,\n  ComponentProps,\n  MemoExoticComponent,\n} from 'react';\n\nexport function memo<P extends Record<string, unknown>>(\n  Component: ComponentType<P>,\n  propsAreEqual?: (\n    prevProps: Readonly<PropsWithChildren<P>>,\n    nextProps: Readonly<PropsWithChildren<P>>,\n  ) => boolean,\n): NamedExoticComponent<P>;\n\nexport function memo<T extends ComponentType<any>>(\n  Component: T,\n  propsAreEqual?: (\n    prevProps: Readonly<ComponentProps<T>>,\n    nextProps: Readonly<ComponentProps<T>>,\n  ) => boolean,\n): MemoExoticComponent<T>;\n\nexport function memo(Component: any, propsAreEqual?: any) {\n  const WrappedComponent = forwardRef((props: any, ref: any) => {\n    Object.values(props).forEach(trackMemo);\n    return createElement(Component, { ...props, ref });\n  });\n  return reactMemo(WrappedComponent, propsAreEqual);\n}\n"],"names":["useAffectedDebugValue","state","affected","pathList","useRef","useEffect","current","affectedToPathList","useDebugValue","createTrackedSelector","useSelector","useTrackedSelector","useReducer","c","forceUpdate","WeakMap","lastAffected","prevState","lastState","isChanged","selector","useCallback","nextState","process","env","NODE_ENV","proxyCache","useMemo","createProxy","createContainer","useValue","options","console","warn","concurrentMode","stateContextName","updateContextName","StateContext","createContext","defaultState","UpdateContext","createContextOrig","defaultUpdate","displayName","Provider","props","update","createElement","value","children","selectorOrig","undefined","Error","selected","useContextSelector","useTrackedState","useUpdate","useContextOrig","contextUpdate","useContextUpdate","result","useTracked","memo","Component","propsAreEqual","WrappedComponent","forwardRef","ref","Object","values","forEach","trackMemo","reactMemo"],"mappings":"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"}